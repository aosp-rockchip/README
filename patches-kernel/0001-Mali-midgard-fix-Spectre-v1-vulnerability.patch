From da6f49f0ddec2aacc04a6e20b81340baeafd8539 Mon Sep 17 00:00:00 2001
From: Zhen Chen <chenzhen@rock-chips.com>
Date: Mon, 1 Apr 2019 16:41:07 +0800
Subject: [PATCH] Mali: midgard: fix Spectre v1 vulnerability

user_atom.atom_number can be indirectly controlled by user-space,
hence leading to a potential exploitation
of the Spectre variant 1 vulnerability.

This issue was detected with the help of Smatch:

drivers/gpu/arm/midgard/mali_kbase_jd.c:1397 kbase_jd_submit() warn:
potential spectre issue 'jctx->atoms' [r]
katom = &jctx->atoms[user_atom.atom_number];

Fix this by sanitizing user_atom.atom_number
before 'katom = &jctx->atoms[user_atom.atom_number];'.

Notice that given that speculation windows are large, the policy is
to kill the speculation on the first load and not worry if it can be
completed with a dependent load/store [1].

[1] https://marc.info/?l=linux-kernel&m=152449131114778&w=2

Fixes: 5cf27d0b6090 ("Mali: midgard: changes to enlarge BASE_JD_ATOM_COUNT to 512, for defect 184210")
Change-Id: If52f30d29a80a06c6693ddadd5947ab9fe8fbc25
Signed-off-by: Zhen Chen <chenzhen@rock-chips.com>
---
 drivers/gpu/arm/midgard/mali_kbase_jd.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/gpu/arm/midgard/mali_kbase_jd.c b/drivers/gpu/arm/midgard/mali_kbase_jd.c
index 25c768a5ca07..68bfa3bedef8 100644
--- a/drivers/gpu/arm/midgard/mali_kbase_jd.c
+++ b/drivers/gpu/arm/midgard/mali_kbase_jd.c
@@ -28,6 +28,7 @@
 #include <linux/random.h>
 #include <linux/version.h>
 #include <linux/ratelimit.h>
+#include <linux/nospec.h>
 
 #include <mali_kbase_jm.h>
 #include <mali_kbase_hwaccess_jm.h>
@@ -1394,6 +1395,13 @@ while (false)
 #undef compiletime_assert
 #undef compiletime_assert_defined
 #endif
+		if (user_atom.atom_number >= BASE_JD_ATOM_COUNT) {
+			err = -EINVAL;
+			break;
+		}
+		user_atom.atom_number =
+			array_index_nospec(user_atom.atom_number,
+					   BASE_JD_ATOM_COUNT);
 		katom = &jctx->atoms[user_atom.atom_number];
 
 		/* Record the flush ID for the cache flush optimisation */
-- 
2.35.3

