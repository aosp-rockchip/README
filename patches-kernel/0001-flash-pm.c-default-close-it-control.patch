From 4e09917dcd6bdf56d6cceaf07fc051af330c904e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E5=AE=8B=E7=A7=80=E6=9D=B0?= <sxj@rock-chips.com>
Date: Tue, 14 Sep 2010 07:20:07 -0700
Subject: [PATCH] flash pm.c, default close it control

---
 arch/arm/mach-rk2818/pm.c | 55 ++++++++++++++++-----------------------
 1 file changed, 22 insertions(+), 33 deletions(-)

diff --git a/arch/arm/mach-rk2818/pm.c b/arch/arm/mach-rk2818/pm.c
index ba48fee04149..06af12887d89 100755
--- a/arch/arm/mach-rk2818/pm.c
+++ b/arch/arm/mach-rk2818/pm.c
@@ -81,15 +81,6 @@ static inline u32 sdram_get_mem_type(void)
 #define MODE5_CNT(n)       (((n) & 0xFFFF) << 16)
 #define CTRL_REG_62        0xf8  // LOWPOWER_INTERNAL_CNT/LOWPOWER_EXTERNAL_CNT.
 
-/****************************************************************/
-//å‡½æ•°å: sdram_enter_self_refresh
-//æè¿°: SDRAMè¿›å…¥è‡ªåˆ·æ–°æ¨¡å¼
-//å‚æ•°è¯´æ˜Ž:
-//è¿”å›žå€¼: å¯¹äºŽDDRå°±æ˜¯CTRL_REG_62çš„å€¼ï¼Œä¾›sdram_exit_self_refreshä½¿ç”¨
-//ç›¸å…³å…¨å±€å˜é‡:
-//æ³¨æ„:(1)ç³»ç»Ÿå®Œå…¨idleåŽæ‰èƒ½è¿›å…¥è‡ªåˆ·æ–°æ¨¡å¼ï¼Œè¿›å…¥è‡ªåˆ·æ–°åŽä¸èƒ½å†è®¿é—®SDRAM
-//     (2)è¦è¿›å…¥è‡ªåˆ·æ–°æ¨¡å¼ï¼Œå¿…é¡»ä¿è¯è¿è¡Œæ—¶è¿™ä¸ªå‡½æ•°æ‰€è°ƒç”¨åˆ°çš„æ‰€æœ‰ä»£ç ä¸åœ¨SDRAMä¸Š
-/****************************************************************/
 u32 __tcmfunc sdram_enter_self_refresh(void)
 {
 	u32 r;
@@ -100,7 +91,7 @@ u32 __tcmfunc sdram_enter_self_refresh(void)
 	case MOBILE_SDRAM:
 		msdr_writel(msdr_readl(MSDR_SCTLR) | ENTER_SELF_REFRESH, MSDR_SCTLR);
 
-		while (!(msdr_readl(MSDR_SCTLR) & SR_MODE));  //ç¡®å®šå·²ç»è¿›å…¥self-refresh
+		while (!(msdr_readl(MSDR_SCTLR) & SR_MODE));  
 
 		/* Disable Mobile SDRAM/SDRAM Common/Controller hclk clock */
 		r = scu_readl(SCU_CLKGATE1_CON);
@@ -116,22 +107,13 @@ u32 __tcmfunc sdram_enter_self_refresh(void)
 	case MOBILE_DDR:
 		r = ddr_readl(CTRL_REG_62);
 		ddr_writel((r & ~MODE5_MASK) | MODE5_CNT(1), CTRL_REG_62);
-		//FIXME: ç­‰å¾…è¿›å…¥self-refresh
+		
 		break;
 	}
 
 	return r;
 }
 
-/****************************************************************/
-//å‡½æ•°å: sdram_exit_self_refresh
-//æè¿°: SDRAMé€€å‡ºè‡ªåˆ·æ–°æ¨¡å¼
-//å‚æ•°è¯´æ˜Ž:
-//è¿”å›žå€¼:
-//ç›¸å…³å…¨å±€å˜é‡:
-//æ³¨æ„:(1)SDRAMåœ¨è‡ªåˆ·æ–°æ¨¡å¼åŽä¸èƒ½è¢«è®¿é—®ï¼Œå¿…é¡»å…ˆé€€å‡ºè‡ªåˆ·æ–°æ¨¡å¼
-//     (2)å¿…é¡»ä¿è¯è¿è¡Œæ—¶è¿™ä¸ªå‡½æ•°çš„ä»£ç ä¸åœ¨SDRAMä¸Š
-/****************************************************************/
 void __tcmfunc sdram_exit_self_refresh(u32 ctrl_reg_62)
 {
 	u32 r;
@@ -152,7 +134,7 @@ void __tcmfunc sdram_exit_self_refresh(u32 ctrl_reg_62)
 
 		msdr_writel(msdr_readl(MSDR_SCTLR) & ~ENTER_SELF_REFRESH, MSDR_SCTLR);
 
-		while (msdr_readl(MSDR_SCTLR) & SR_MODE);  //ç¡®å®šé€€å‡ºè¿›å…¥self-refresh
+		while (msdr_readl(MSDR_SCTLR) & SR_MODE);  
 		break;
 
 	case DDRII:
@@ -161,9 +143,9 @@ void __tcmfunc sdram_exit_self_refresh(u32 ctrl_reg_62)
 		break;
 	}
 
-	tcm_udelay(100, 24); //DRVDelayUs(100); å»¶æ—¶ä¸€ä¸‹æ¯”è¾ƒå®‰å…¨ï¼Œä¿è¯é€€å‡ºåŽç¨³å®š
+	tcm_udelay(100, 24); //DRVDelayUs(100); 
 }
-#define RK2818_MOBLIE_PM_CON
+//#define RK2818_MOBLIE_PM_CON
 #ifdef RK2818_MOBLIE_PM_CON
 
 #define RK2818_MOBLIE_PM_PRT_ORIGINAL_REG
@@ -297,16 +279,15 @@ static void __tcmfunc rk2818_pm_suspend_first(struct rk2818_pm_st *pm_save)
 	pm_save->gpio1_regbit=0x6db;
 	//pm_save->savereg[0]=rk2818_ddr_reg[82];
 	//rk2818_ddr_reg[82]=rk2818_ddr_reg[82]&(~(0xffff))&(~(0xf<<20));
-	
-	//pm_set_gpio_pinstate(RK2818_PIN_PC2,1,0);		//¿ØÖÆPMUµÄDVS½Å
+	//pm_set_gpio_pinstate(RK2818_PIN_PC2,1,0);
 }
 
 static void __tcmfunc rk2818_pm_resume_first(struct rk2818_pm_st *pm_save)
 {
 	unsigned int *rk2818_ddr_reg=(unsigned int *)RK2818_SDRAMC_BASE;
 	
-	//pm_set_gpio_pinstate(RK2818_PIN_PC2,1,1);		//¿ØÖÆPMUµÄDVS½Å
-	
+	//pm_set_gpio_pinstate(RK2818_PIN_PC2,1,1);
+
 	//rk2818_ddr_reg[82]=pm_save->save[0];
 
 }
@@ -365,6 +346,10 @@ static void __tcmfunc rk2818_soc_scu_suspend(struct rk2818_pm_st *pm_save)
 }
 //  output 1 is a output pin 
 
+
+
+
+
 static void __tcmfunc rk2818_soc_general_cpu_suspend(struct rk2818_pm_st *pm_save)
 {
 
@@ -465,6 +450,7 @@ static void __tcmfunc rk2818_soc_general_cpu_suspend(struct rk2818_pm_st *pm_sav
 }
 static void rk2818_pm_reg_print(unsigned int *pm_save_reg,unsigned int *pm_ch_reg,int num,char *name)
 {
+
 	 int i;
 
 #ifdef RK2818_MOBLIE_PM_PRT_ORIGINAL_REG
@@ -545,8 +531,12 @@ static int __tcmfunc rk2818_tcm_idle(void)
 	rk2818_pm_suspend_first((struct rk2818_pm_st *)&pm_save.pm_scu_reg);
 	tcm_udelay(1, 24);
 	rk2818_pm_soc_suspend((struct rk2818_pm_st *)&pm_save.pm_scu_reg);
+	//pm_set_gpio_pinstate(RK2818_PIN_PC2,1,0);
+
 	tcm_udelay(1, 24);
 	asm("mcr p15, 0, r0, c7, c0, 4");	/* wait for interrupt */
+	//pm_set_gpio_pinstate(RK2818_PIN_PC2,1,1);
+
 	rk2818_pm_resume_first((struct rk2818_pm_st *)&pm_save.pm_scu_reg);
 	tcm_udelay(1, 24);
 	rk2818_pm_soc_resume((struct rk2818_pm_st *)&pm_save.pm_scu_reg);
@@ -569,7 +559,7 @@ static int __tcmfunc rk2818_tcm_idle(void)
 	tcm_udelay(5, 24);
 
 	scu_writel(scu_mode, SCU_MODE_CON); // normal
-	rk2818_pm_print((struct rk2818_pm_st *)&pm_save.pm_scu_reg);
+	//rk2818_pm_print((struct rk2818_pm_st *)&pm_save.pm_scu_reg);
 	return unit;
 }
 
@@ -587,10 +577,10 @@ static void rk2818_idle(void)
 static int rk2818_pm_enter(suspend_state_t state)
 {
 	int irq_val = 0;
-      struct regulator *buck1;
-	u32 scu_mode = scu_readl(SCU_MODE_CON);
-	u32 scu_apll = scu_readl(SCU_APLL_CON);
-	u32 scu_clksel0 = scu_readl(SCU_CLKSEL0_CON);
+//      struct regulator *buck1;
+//	u32 scu_mode = scu_readl(SCU_MODE_CON);
+//	u32 scu_apll = scu_readl(SCU_APLL_CON);
+//	u32 scu_clksel0 = scu_readl(SCU_CLKSEL0_CON);
 
 	printk(KERN_DEBUG "before core halt\n");
 
@@ -633,4 +623,3 @@ static int __init rk2818_pm_init(void)
 }
 
 __initcall(rk2818_pm_init);
-
-- 
2.35.3

